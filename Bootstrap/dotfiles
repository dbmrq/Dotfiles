#!/usr/bin/env bash
#
# Dotfiles CLI - interactive dotfiles management
#
# Just run 'dotfiles' to see an interactive menu.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

source "$SCRIPT_DIR/lib.sh"

cd "$DOTFILES_DIR"

# --- Actions ---

do_sync() {
    print_header "Syncing dotfiles..."
    print_info "Pulling latest changes..."
    if git pull --rebase; then
        print_ok "Repository updated"
    else
        print_error "Failed to pull changes"
        return 1
    fi
    print_info "Restowing packages..."
    "$SCRIPT_DIR/stow.sh" --force
    print_ok "Sync complete!"
}

do_status() {
    echo ""
    echo -e "${BOLD}Dotfiles Status${NC}"
    echo "Directory: $DOTFILES_DIR"
    echo ""

    # Git status
    echo -e "${BOLD}Git:${NC}"
    if git diff --quiet && git diff --cached --quiet; then
        print_ok "Working tree clean"
    else
        git status --short
    fi
    local ahead
    ahead=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo "0")
    if [[ "$ahead" -gt 0 ]]; then
        print_warn "$ahead commit(s) ahead of remote"
    fi
    echo ""

    # Stow status
    echo -e "${BOLD}Symlinks:${NC}"
    "$SCRIPT_DIR/stow.sh" --verify || true
}

do_edit() {
    local editor="${EDITOR:-vim}"
    print_info "Opening $DOTFILES_DIR in $editor..."
    $editor .
}

do_stow() {
    print_header "Restowing packages..."
    "$SCRIPT_DIR/stow.sh" --force
}

# --- Menu ---

show_menu() {
    echo ""
    echo -e "${BOLD}Dotfiles${NC}"
    echo "Directory: $DOTFILES_DIR"
    echo ""
    echo "What would you like to do?"
    echo ""
    echo "  ${BOLD}1)${NC} Sync     - Pull latest changes and restow symlinks"
    echo "  ${BOLD}2)${NC} Status   - Check git and symlink status"
    echo "  ${BOLD}3)${NC} Edit     - Open dotfiles in \$EDITOR"
    echo "  ${BOLD}4)${NC} Stow     - Just restow symlinks (no git pull)"
    echo "  ${BOLD}q)${NC} Quit"
    echo ""
}

# --- Main ---

# If arguments provided, handle as direct command (for scripting)
if [[ $# -gt 0 ]]; then
    case "$1" in
        sync)   do_sync ;;
        status) do_status ;;
        edit)   do_edit ;;
        stow)   do_stow ;;
        cd)     echo "$DOTFILES_DIR" ;;
        *)
            echo "Usage: dotfiles [sync|status|edit|stow|cd]"
            echo "Or just run 'dotfiles' for interactive menu."
            exit 1
            ;;
    esac
    exit 0
fi

# Interactive menu
show_menu

while true; do
    read -rp "Choose [1-4, q]: " choice
    case "$choice" in
        1|sync)
            do_sync
            break
            ;;
        2|status)
            do_status
            break
            ;;
        3|edit)
            do_edit
            break
            ;;
        4|stow)
            do_stow
            break
            ;;
        q|Q|quit|exit)
            echo "Bye!"
            break
            ;;
        *)
            echo "Invalid choice. Please enter 1-4 or q."
            ;;
    esac
done
